stages:
  - build
  - test
  - deploy

variables:
  NODE_ENV: development

before_script:
  # Login to Docker Hub for build + push
  - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

# Build client (artifact for unit tests)
build-client-job:
  stage: build
  image: node:18
  script:
    - cd geolocation
    - npm ci
    - npm run build
  artifacts:
    paths:
      - geolocation/dist
    expire_in: 1 hour

# Build server (Docker image, push to Docker Hub)
build-server-job:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - docker build -t $DOCKERHUB_USERNAME/geolocation-server:$CI_COMMIT_SHA server
    - docker push $DOCKERHUB_USERNAME/geolocation-server:$CI_COMMIT_SHA
    # Optionally tag latest for convenience
    - docker tag $DOCKERHUB_USERNAME/geolocation-server:$CI_COMMIT_SHA $DOCKERHUB_USERNAME/geolocation-server:latest
    - docker push $DOCKERHUB_USERNAME/geolocation-server:latest

# Unit tests for client
unit-test-client-job:
  stage: test
  image: node:18
  needs:
    - job: build-client-job
      artifacts: true
  script:
    - cd geolocation
    - npm ci
    - npm run test

# Deploy server (via Kamal)
deploy-server-job:
  stage: deploy
  image: ruby:3.2
  needs:
    - job: build-server-job
  before_script:
    - gem install kamal
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
  script:
    - cd server
    - kamal deploy
  only:
    - main