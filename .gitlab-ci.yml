stages:
  - build
  - test

variables:
  NODE_ENV: development

# Build client
build-client-job:
  stage: build
  image: node:18
  script:
    - cd geolocation
    - npm ci
    - npm run build
  artifacts:
    paths:
      - geolocation/dist
    expire_in: 1 hour

# Build server
build-server-job:
  stage: build
  image: node:18
  script:
    - cd server
    - npm ci
  artifacts:
    paths:
      - server
    expire_in: 1 hour

# Unit tests for client
unit-test-client-job:
  stage: test
  image: node:18
  needs:
    - job: build-client-job
      artifacts: true
  script:
    - cd geolocation
    - npm ci
    - npm run test

# Autotest job (Playwright)
auto-test-job:
  stage: test
  image: mcr.microsoft.com/playwright:v1.48.0-jammy  # Playwright Docker image
  needs:
    - job: build-client-job
      artifacts: true
    - job: build-server-job
      artifacts: true
  script:
    # Clone the autotest repo
    - git clone https://github.com/luuphuphat69/autotest-geolocation.git autotest
    - cd autotest

    # Install dependencies
    - npm ci

    # Install Playwright browsers
    - npx playwright install --with-deps

    # Run tests
    - npx playwright test --reporter=html

  artifacts:
    when: always
    paths:
      - autotest/playwright-report
    expire_in: 1 week
